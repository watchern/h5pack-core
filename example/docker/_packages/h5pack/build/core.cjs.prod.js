"use strict";var e=require("path"),a=require("fs/promises"),s=require("fs"),t=require("ora"),o=require("child_process");function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=r(t);let n;let i=c.default(),l=c.default();function p(e){n.log&&l.info(e)}async function u(e){try{await a.rm(e,{recursive:!0,force:!0}),i.succeed("ðŸ™ˆ Success clear cache"),console.log("success clear data")}catch(a){i.fail(`ðŸ™ˆ remove temp dir fail in ${e}`)}}function w(e){return s.existsSync(e)}async function d(a,t){s.existsSync(t)||s.mkdirSync(t,{recursive:!0}),await u(t);const o=s.readdirSync(a);for(const r of o){const o=e.join(a,r),c=e.join(t,r);s.statSync(o).isDirectory()?await d(o,c):s.copyFileSync(o,c)}}const h={github:"https://github.com/watchern/h5pack_react_native.git",gitee:"https://gitee.com/jimmyxuexue/h5pack-native.git"},g={code:1e4,message:"cloneå¼‚å¸¸ï¼Œæ£€æŸ¥ç½‘ç»œä»£ç†ï¼Œæˆ–é…ç½®ä¸ºå›½å†…ä»£ç†"},f={code:10001,message:"èŽ·å–é™æ€èµ„æºå¼‚å¸¸ï¼Œæ£€æŸ¥h5pack.jsonä¸­entryé…ç½®"},y={code:10003,message:".envæ–‡ä»¶ç”Ÿæˆå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­nameé…ç½®"},m={code:10004,message:"splashå¯åŠ¨é¡µç”Ÿæˆå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­splashç›¸å…³é…ç½®"},v={code:10005,message:"release APPå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥å®‰å“æ‰“åŒ…çŽ¯å¢ƒ"},k={code:10006,message:"copy releaseå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­outputé…ç½®"},b={code:10007,message:"appLogoå¯åŠ¨é¡µç”Ÿæˆå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥h5pack.jsonä¸­logoç›¸å…³é…ç½®"};function $(e,a,s=[],t){return new Promise(((t,r)=>{p(""),p(`handleCommand stdout: ${e}`);const c=a+" "+s.join(" ");p(`handleCommand stdout: ${a},${s},${e}`);const n=o.spawn(a,s,{cwd:e});n.stdout.on("data",(e=>{p(`${c} stdout: ${e}`)})),n.stderr.on("data",(e=>{p(`${c} stderr: ${e}`)})),n.on("close",(e=>{0!==e?r(new Error(`${c} exited with code ${e}`)):t(!0)}))})).catch((e=>{t?.(e.message)}))}class j extends Error{failMessage=void 0;originErrorMessage;constructor(e,a){super(),this.failMessage=e,this.originErrorMessage=a}}async function S(s){await async function(s){const t=`\n  APP_NAME=${n.name||"H5Pack"}\n  `;try{await a.writeFile(e.resolve(s,".env"),t,"utf-8")}catch(e){throw new j(y,e.message||"write env file error")}}(s),await async function(s){if(n.splash)try{const t=e.basename(n.splash),o=e.resolve(process.cwd(),n.splash),r=e.resolve(s,`./public/splash/${t}`);if(!w(o))throw new Error("packConfig.splash is not a available path");await a.copyFile(o,r),await $(s,"yarn",["react-native","generate-bootsplash",e.resolve(s,`./public/splash/${t}`),"--platforms=android"],(e=>{throw new Error(e)}))}catch(e){throw new j(m,e.message)}}(s),await async function(s){if(n.logo)try{const t=e.basename(n.logo),o=e.resolve(process.cwd(),n.logo),r=e.resolve(s,`./public/logo/${t}`);w(o)&&(await a.copyFile(o,r),await $(s,"npx",["iconkits",`--input=./public/logo/${t}`],(e=>{throw new Error(e)})))}catch(e){throw new j(b,e.message)}}(s),i.stop(),i.succeed("âœ… Custom Config Success")}async function C(a,s){try{const t=e.resolve(process.cwd(),n.entry);if(!w(t))return void s("packConfig.entry is not a available path");const o=e.join(a,"./h5pack-native/public/webview/dist");await d(t,o)}catch(e){s(e.message||"packConfig.entry is not a available path")}}async function E(a){const t=e.join(a,"./h5pack-native");i.start("ðŸš© ls ......"),await $(t,"ls",[],(e=>{throw i.stop(),new j(g,e)})),i.start("ðŸš© Download Source ......"),await $(a,"git",["clone",h[n.registry],t],(e=>{throw i.stop(),new j(g,e)})),i.succeed("âœ… download success!"),i.start("ðŸš© ls ......"),await $(t,"ls",[],(e=>{throw i.stop(),new j(g,e)})),await C(a,(e=>{throw new j(f,e)})),i.start("ðŸš© ls ......"),await $(t,"ls",[],(e=>{throw i.stop(),new j(g,e)})),i.start("ðŸš© Install Dependencies ......"),await $(t,"yarn",[],(e=>{throw i.stop(),new j(g,e)})),i.succeed("âœ… Dependencies Installed!"),i.start("ðŸš© Handle Custom Config ......"),await S(t),i.succeed("âœ… Handle Success!"),i.start("ðŸ˜Š Building App ......"),await $(t,"yarn",["release"],(e=>{throw i.stop(),new j(v,e)})),i.stop(),i.start("âœ… building Success ......"),i.start("ðŸ˜Š Generate Apk ......"),await async function(a,t){try{const t=e.resolve(process.cwd(),n.output||"./");if(!w(t))throw new Error("packConfig.output is not a available path");await s.promises.copyFile(e.join(a,"./h5pack-native/android/app/build/outputs/apk/release/app-release.apk"),e.resolve(t,"app-release.apk"))}catch(e){t(e.message||"packConfig.output is not a available path")}}(a,(e=>{throw new j(k,e)})),i.stop(),i.succeed("ðŸŽ‰ Packaging completed !!! ðŸŽ‰")}let x;async function M(){try{const a=process.cwd();x=e.join(a,"app-build"),await s.promises.mkdir(x,{recursive:!0}),await E(x)}catch(e){!function(e){const a=c.default();a.fail(`error: ${e.failMessage?.message},code: ${e.failMessage?.code}, message: ${e?.originErrorMessage}`),a.clear()}(e),await u(x)}}process.on("SIGINT",(async()=>{await u(x),process.exit()})),module.exports=()=>{n=require(e.resolve(process.cwd(),"h5pack.json")),n.registry=n.registry||"github",M()};
